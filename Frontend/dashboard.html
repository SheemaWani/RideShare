<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Your Dashboard - RideShare</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .hero-bg { background-image: url('https://images.unsplash.com/photo-1533473359331-0135ef1b58bf?q=80&w=2070'); }
        #cancel-confirmation-modal.hidden, #challan-modal.hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="relative min-h-screen bg-cover bg-center bg-fixed hero-bg">
        <div class="absolute inset-0 bg-black bg-opacity-60"></div>

        <header class="absolute top-0 left-0 w-full p-4 sm:p-6 flex justify-between items-center z-20">
            <a href="/frontend/index.html" class="flex items-center gap-2 text-white text-xl sm:text-2xl font-bold">
                <span class="material-icons text-3xl sm:text-4xl">directions_car</span>
                <span>RideShare</span>
            </a>
            <nav class="flex items-center gap-4 text-white">
                <a href="/frontend/search-results.html" class="hidden sm:flex items-center gap-2 font-medium hover:text-sky-300 transition-colors">
                    <span class="material-icons">explore</span>
                    Browse Rides
                </a>
                <a href="/frontend/publish-ride.html" class="flex items-center gap-2 bg-sky-500 hover:bg-sky-600 font-medium px-4 py-2 rounded-full transition-colors">
                    <span class="material-icons">add_circle_outline</span>
                    Publish a ride
                </a>
                <div class="relative">
                    <button id="profileButton" class="flex items-center gap-2 focus:outline-none rounded-full">
                        <img id="header-profile-picture" src="https://placehold.co/40x40/e2e8f0/64748b?text=U" alt="Profile" class="w-10 h-10 rounded-full object-cover border-2 border-gray-400 hover:border-white transition">
                    </button>
                    <div id="profileMenu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl py-2 text-gray-800">
                        <a href="/frontend/profile.html" class="flex items-center gap-3 px-4 py-2 hover:bg-gray-100"><span class="material-icons">person</span> My Profile</a>
                        <button onclick="logout()" class="w-full text-left flex items-center gap-3 px-4 py-2 hover:bg-gray-100"><span class="material-icons">logout</span> Logout</button>
                    </div>
                </div>
            </nav>
        </header>

        <main class="relative z-10 flex flex-col items-center justify-start min-h-screen text-center p-4 pt-32">
            <div class="w-full max-w-4xl">
                <h1 class="text-4xl sm:text-5xl font-bold text-white mb-4">Welcome Back, <span id="username-placeholder">User</span>!</h1>
                <p class="text-lg text-gray-200 mb-8">Find a new ride or manage your existing ones.</p>
                <form id="searchForm" class="w-full bg-white bg-opacity-90 p-4 rounded-xl shadow-2xl grid grid-cols-1 md:grid-cols-5 gap-3 mb-8">
                    <input type="text" name="origin" class="md:col-span-2 text-gray-800 p-3 rounded-lg border-2 border-gray-200 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Leaving from..." required>
                    <input type="text" name="destination" class="md:col-span-2 text-gray-800 p-3 rounded-lg border-2 border-gray-200 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Going to..." required>
                    <button type="submit" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-bold p-3 rounded-lg flex items-center justify-center gap-2 transition-colors">
                      <span class="material-icons">search</span>
                      <span>Search</span>
                    </button>
                </form>

                <div class="bg-white bg-opacity-90 backdrop-blur-sm p-4 sm:p-6 rounded-2xl shadow-2xl text-left">
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                            <button id="tab-published" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-sky-500 text-sky-600">My Published Rides</button>
                            <button id="tab-booked" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">My Booked Rides</button>
                            <button id="tab-vehicles" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">My Vehicles</button>
                        </nav>
                    </div>
                    <div class="mt-6">
                        <div id="panel-published"><div id="published-rides-list" class="space-y-4"></div></div>
                        <div id="panel-booked" class="hidden"><div id="booked-rides-list" class="space-y-4"></div></div>
                        <div id="panel-vehicles" class="hidden">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Your Registered Vehicles</h3>
                            <div id="vehicles-list" class="space-y-3 mb-6"></div>
                            <hr class="my-6">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Add a New Vehicle</h3>
                            <form id="addVehicleForm" class="space-y-4">
                                <div id="vehicleFormError" class="hidden p-3 bg-red-100 text-red-700 rounded-lg"></div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <input type="text" name="model" placeholder="Car Model (e.g., Honda City)" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500">
                                    <input type="text" name="registration_number" placeholder="Registration No. (e.g., UP16AB1234)" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500" pattern="^[A-Z]{2}[ -]?[0-9]{1,2}[ -]?[A-Z]{1,3}[ -]?[0-9]{1,4}$" title="Please enter a valid registration number (e.g., UP16AB1234)." oninput="this.value = this.value.toUpperCase()">
                                </div>
                                <button type="submit" class="w-full sm:w-auto bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-6 rounded-lg transition-colors">Add Vehicle</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="cancel-confirmation-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-30">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center max-w-sm mx-auto">
            <h3 id="cancel-modal-title" class="text-lg font-bold mb-4">Are you sure?</h3>
            <p id="cancel-modal-text" class="text-gray-600 mb-6">This action cannot be undone.</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-action-btn" class="px-6 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg">Cancel</button>
                <button id="confirm-action-btn" class="px-6 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg">Confirm</button>
            </div>
        </div>
    </div>
    
    <div id="challan-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-30">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center max-w-sm mx-auto">
            <h3 class="text-lg font-bold mb-4">Challan Status</h3>
            <div id="challan-modal-content" class="text-gray-600 mb-6"></div>
            <button id="close-challan-modal" class="px-6 py-2 bg-sky-500 text-white rounded-lg">Close</button>
        </div>
    </div>

    <script>
        const authToken = localStorage.getItem('authToken');
        if (!authToken) { window.location.href = '/frontend/signup.html'; }

        // DOM Elements
        const usernamePlaceholder = document.getElementById('username-placeholder');
        const profileButton = document.getElementById('profileButton');
        const profileMenu = document.getElementById('profileMenu');
        const headerProfilePicture = document.getElementById('header-profile-picture');
        const searchForm = document.getElementById('searchForm');
        const tabPublished = document.getElementById('tab-published');
        const tabBooked = document.getElementById('tab-booked');
        const tabVehicles = document.getElementById('tab-vehicles');
        const panelPublished = document.getElementById('panel-published');
        const panelBooked = document.getElementById('panel-booked');
        const panelVehicles = document.getElementById('panel-vehicles');
        const publishedRidesList = document.getElementById('published-rides-list');
        const bookedRidesList = document.getElementById('booked-rides-list');
        const vehiclesList = document.getElementById('vehicles-list');
        const addVehicleForm = document.getElementById('addVehicleForm');
        const vehicleFormError = document.getElementById('vehicleFormError');
        const cancelConfirmationModal = document.getElementById('cancel-confirmation-modal');
        const cancelActionBtn = document.getElementById('cancel-action-btn');
        const confirmActionBtn = document.getElementById('confirm-action-btn');
        const cancelModalTitle = document.getElementById('cancel-modal-title');
        const cancelModalText = document.getElementById('cancel-modal-text');
        const challanModal = document.getElementById('challan-modal');
        const challanModalContent = document.getElementById('challan-modal-content');
        const closeChallanModal = document.getElementById('close-challan-modal');
        const backendUrl = 'http://localhost:3001';

        let actionToConfirm = null;

        async function fetchAPI(url, options = {}) {
            try {
                const response = await fetch(`${backendUrl}${url}`, {
                    headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' },
                    ...options
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.message || 'API request failed');
                return data;
            } catch (error) {
                console.error(`API Error on ${url}:`, error);
                throw error;
            }
        }

        function renderUserProfile(user) {
            if (user) {
                usernamePlaceholder.textContent = user.username;
                if (user.profile_picture_url) {
                    const fullImageUrl = `${backendUrl}${user.profile_picture_url}`;
                    headerProfilePicture.src = fullImageUrl;
                    localStorage.setItem('userProfilePictureUrl', fullImageUrl);
                }
            }
        }

        function renderPublishedRides(rides) {
            publishedRidesList.innerHTML = (!rides || rides.length === 0)
                ? `<p class="text-center text-gray-500 p-4">You have no active published rides.</p>`
                : rides.map(ride => {
                    const departureTime = new Date(ride.departure_time);
                    const dateString = departureTime.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                    const timeString = departureTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true });
                    const passengersHtml = ride.passengers && ride.passengers.length > 0
                        ? ride.passengers.map(p => `<div class="flex items-center gap-2"><img src="${p.profile_picture_url ? backendUrl + p.profile_picture_url : 'https://placehold.co/24x24/e2e8f0/64748b?text=P'}" alt="${p.username}" class="w-6 h-6 rounded-full object-cover"><span class="text-sm text-gray-800">${p.username}</span></div>`).join('')
                        : '<p class="text-xs text-gray-500">No passengers have booked yet.</p>';
                    return `
                    <div class="bg-gray-50 p-4 rounded-lg border" id="ride-card-${ride.ride_id}">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-bold text-lg text-gray-800">${ride.origin} → ${ride.destination}</p>
                                <p class="text-sm text-gray-600">${dateString} at ${timeString}</p>
                            </div>
                            <button class="cancel-ride-btn text-red-500 hover:text-red-700 font-semibold text-sm" data-ride-id="${ride.ride_id}">Cancel Ride</button>
                        </div>
                        <div class="mt-3 pt-3 border-t border-gray-200">
                            <p class="font-semibold text-gray-700 mb-2 text-sm">Passengers Booked:</p>
                            <div class="flex flex-wrap gap-x-4 gap-y-2">${passengersHtml}</div>
                        </div>
                    </div>`;
                }).join('');
        }

        function renderBookedRides(bookings) {
            bookedRidesList.innerHTML = (!bookings || bookings.length === 0)
                ? `<p class="text-center text-gray-500 p-4">You have no upcoming trips.</p>`
                : bookings.map(booking => {
                    const departureTime = new Date(booking.departure_time);
                    const dateString = departureTime.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                    const timeString = departureTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true });
                    return `
                    <div class="bg-gray-50 p-4 rounded-lg border" id="booking-card-${booking.booking_id}">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-bold text-lg text-gray-800">${booking.origin} → ${booking.destination}</p>
                                <p class="text-sm text-gray-600">${dateString} at ${timeString}</p>
                            </div>
                            <button class="cancel-booking-btn text-red-500 hover:text-red-700 font-semibold text-sm" data-booking-id="${booking.booking_id}">Cancel Booking</button>
                        </div>
                        <div class="mt-3 pt-3 border-t border-gray-200">
                            <p class="font-semibold text-gray-700 mb-2">Contact Driver:</p>
                            <div class="flex items-center gap-3">
                                <img src="${booking.profile_picture_url ? backendUrl + booking.profile_picture_url : 'https://placehold.co/40x40/e2e8f0/64748b?text=D'}" alt="${booking.driver_name}" class="w-10 h-10 rounded-full object-cover">
                                <div>
                                    <p class="text-sm font-semibold text-gray-900">${booking.driver_name}</p>
                                    <p class="text-sm text-gray-600">${booking.driver_contact || 'No contact provided'}</p>
                                </div>
                            </div>
                        </div>
                    </div>`;
                }).join('');
        }
        
        function renderVehicles(vehicles) {
            vehiclesList.innerHTML = (!vehicles || vehicles.length === 0)
                ? `<p class="text-gray-500">You haven't registered any vehicles yet.</p>`
                : vehicles.map(v => `
                    <div class="bg-gray-50 p-3 rounded-lg border" id="vehicle-${v.vehicle_id}">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-semibold text-gray-800">${v.model}</p>
                                <p class="text-sm text-gray-600">${v.registration_number}</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <button class="check-challan-btn text-xs font-bold py-1 px-3 rounded-full bg-yellow-400 hover:bg-yellow-500 text-yellow-900" data-vehicle-id="${v.vehicle_id}">Check Challans</button>
                                ${v.is_verified
                                    ? `<div class="flex items-center gap-1 text-green-600 font-semibold text-sm"><span class="material-icons text-base">verified</span> Verified</div>`
                                    : `<button class="verify-vehicle-btn bg-blue-500 hover:bg-blue-600 text-white text-xs font-bold py-1 px-3 rounded-full" data-vehicle-id="${v.vehicle_id}">Verify</button>`
                                }
                                <button class="delete-vehicle-btn text-red-500 hover:text-red-700 text-sm font-semibold" data-vehicle-id="${v.vehicle_id}">Delete</button>
                            </div>
                        </div>
                        <div id="verify-form-${v.vehicle_id}" class="hidden mt-3 pt-3 border-t">
                             <p class="text-xs text-gray-500 mb-2">Enter the owner's name exactly as it appears on the RC.</p>
                            <div class="flex gap-2">
                                <input type="text" placeholder="Owner's Name (on RC)" class="w-full p-2 border rounded-md text-sm">
                                <button class="submit-verify-btn bg-green-500 text-white text-xs font-bold py-1 px-3 rounded-full" data-vehicle-id="${v.vehicle_id}">Submit</button>
                            </div>
                        </div>
                    </div>
                `).join('');
        }

        function handleTabClick(activeTab, activePanel, inactiveTabs, inactivePanels) {
            activePanel.classList.remove('hidden');
            activeTab.className = 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-sky-500 text-sky-600';
            inactivePanels.forEach(panel => panel.classList.add('hidden'));
            inactiveTabs.forEach(tab => tab.className = 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300');
        }
        tabPublished.addEventListener('click', () => handleTabClick(tabPublished, panelPublished, [tabBooked, tabVehicles], [panelBooked, panelVehicles]));
        tabBooked.addEventListener('click', () => handleTabClick(tabBooked, panelBooked, [tabPublished, tabVehicles], [panelPublished, panelVehicles]));
        tabVehicles.addEventListener('click', () => handleTabClick(tabVehicles, panelVehicles, [tabPublished, tabBooked], [panelPublished, panelBooked]));
        
        profileButton.addEventListener('click', () => profileMenu.classList.toggle('hidden'));
        window.addEventListener('click', (e) => { if (!profileButton.contains(e.target) && !profileMenu.contains(e.target)) profileMenu.classList.add('hidden'); });
        
        function logout() { localStorage.removeItem('authToken'); localStorage.removeItem('userProfilePictureUrl'); window.location.href = '/frontend/index.html'; }
        
        searchForm.addEventListener('submit', (e) => { e.preventDefault(); const o = e.target.elements.origin.value; const d = e.target.elements.destination.value; if (o && d) window.location.href = `/frontend/search-results.html?origin=${encodeURIComponent(o)}&destination=${encodeURIComponent(d)}`; });
        
        addVehicleForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            vehicleFormError.classList.add('hidden');
            const registrationRegex = /^[A-Z]{2}[ -]?[0-9]{1,2}[ -]?[A-Z]{1,3}[ -]?[0-9]{1,4}$/i;
            const regNumber = new FormData(addVehicleForm).get('registration_number');
            if (!registrationRegex.test(regNumber)) {
                vehicleFormError.textContent = 'Invalid registration number format.';
                vehicleFormError.classList.remove('hidden');
                return;
            }
            const data = Object.fromEntries(new FormData(addVehicleForm).entries());
            try {
                await fetchAPI('/api/vehicles/add', { method: 'POST', body: JSON.stringify(data) });
                addVehicleForm.reset();
                const updatedVehicles = await fetchAPI('/api/vehicles/my-vehicles');
                renderVehicles(updatedVehicles);
            } catch (error) {
                vehicleFormError.textContent = error.message;
                vehicleFormError.classList.remove('hidden');
            }
        });

        const mainContent = document.querySelector('main');
        mainContent.addEventListener('click', async (e) => {
            const target = e.target;
            if (target.classList.contains('cancel-ride-btn') || target.classList.contains('cancel-booking-btn') || target.classList.contains('delete-vehicle-btn')) {
                let type, id;
                if (target.classList.contains('cancel-ride-btn')) { type = 'ride'; id = target.dataset.rideId; }
                else if (target.classList.contains('cancel-booking-btn')) { type = 'booking'; id = target.dataset.bookingId; }
                else if (target.classList.contains('delete-vehicle-btn')) { type = 'vehicle'; id = target.dataset.vehicleId; }
                
                actionToConfirm = { type, id };
                cancelModalTitle.textContent = `Cancel/Delete ${type}?`;
                cancelModalText.textContent = 'Are you sure? This action cannot be undone.';
                cancelConfirmationModal.classList.remove('hidden');

            } else if (target.classList.contains('verify-vehicle-btn')) {
                const vehicleId = target.dataset.vehicleId;
                document.getElementById(`verify-form-${vehicleId}`).classList.toggle('hidden');
            } else if (target.classList.contains('submit-verify-btn')) {
                const vehicleId = target.dataset.vehicleId;
                const form = document.getElementById(`verify-form-${vehicleId}`);
                const ownerNameInput = form.querySelector('input');
                if (ownerNameInput.value) {
                    try {
                        await fetchAPI(`/api/vehicles/verify/${vehicleId}`, { method: 'POST', body: JSON.stringify({ owner_name: ownerNameInput.value }) });
                        alert('Verification submitted successfully!');
                        const updatedVehicles = await fetchAPI('/api/vehicles/my-vehicles');
                        renderVehicles(updatedVehicles);
                    } catch (error) {
                        alert(`Verification failed: ${error.message}`);
                    }
                } else {
                    alert("Please enter the owner's name.");
                }
            } else if (target.classList.contains('check-challan-btn')) {
                const vehicleId = target.dataset.vehicleId;
                challanModalContent.innerHTML = '<p>Checking...</p>';
                challanModal.classList.remove('hidden');
                try {
                    const result = await fetchAPI(`/api/vehicles/check-challan/${vehicleId}`);
                    const icon = result.challanCount > 0 ? 'warning' : 'check_circle';
                    const color = result.challanCount > 0 ? 'text-red-600' : 'text-green-600';
                    challanModalContent.innerHTML = `<div class="flex justify-center items-center gap-2 ${color}"><span class="material-icons">${icon}</span><p class="font-semibold">${result.message}</p></div>`;
                } catch (error) {
                    challanModalContent.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
                }
            }
        });
        
        closeChallanModal.addEventListener('click', () => challanModal.classList.add('hidden'));

        cancelActionBtn.addEventListener('click', () => {
            cancelConfirmationModal.classList.add('hidden');
            actionToConfirm = null;
        });

        confirmActionBtn.addEventListener('click', async () => {
            if (!actionToConfirm) return;
            const { type, id } = actionToConfirm;
            try {
                let url;
                if (type === 'ride') { url = `/api/rides/${id}`; } 
                else if (type === 'booking') { url = `/api/bookings/${id}`; }
                else if (type === 'vehicle') { url = `/api/vehicles/${id}`; }
                
                await fetchAPI(url, { method: 'DELETE' });
                
                if(type === 'ride') {
                    const updatedRides = await fetchAPI('/api/rides/my-published');
                    renderPublishedRides(updatedRides);
                } else if (type === 'booking') {
                    const updatedBookings = await fetchAPI('/api/rides/my-booked');
                    renderBookedRides(updatedBookings);
                } else if (type === 'vehicle') {
                     const updatedVehicles = await fetchAPI('/api/vehicles/my-vehicles');
                    renderVehicles(updatedVehicles);
                }
                
                alert(`${type.charAt(0).toUpperCase() + type.slice(1)} cancelled/deleted successfully.`);
            } catch (error) {
                alert(`Failed to cancel/delete: ${error.message}`);
            } finally {
                cancelConfirmationModal.classList.add('hidden');
                actionToConfirm = null;
            }
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            if (!authToken) return;

            const cachedImageUrl = localStorage.getItem('userProfilePictureUrl');
            if (cachedImageUrl) {
                headerProfilePicture.src = cachedImageUrl;
            }

            publishedRidesList.innerHTML = `<p class="text-center text-gray-500 p-4">Loading...</p>`;
            bookedRidesList.innerHTML = `<p class="text-center text-gray-500 p-4">Loading...</p>`;
            vehiclesList.innerHTML = `<p class="text-center text-gray-500 p-4">Loading...</p>`;

            fetchAPI('/api/auth/profile').then(renderUserProfile).catch(err => console.error("Profile load failed:", err.message));
            fetchAPI('/api/rides/my-published').then(renderPublishedRides).catch(err => publishedRidesList.innerHTML = `<p class="text-center text-red-500 p-4">Could not load published rides.</p>`);
            fetchAPI('/api/rides/my-booked').then(renderBookedRides).catch(err => bookedRidesList.innerHTML = `<p class="text-center text-red-500 p-4">Could not load booked rides.</p>`);
            fetchAPI('/api/vehicles/my-vehicles').then(renderVehicles).catch(err => vehiclesList.innerHTML = `<p class="text-center text-red-500 p-4">Could not load vehicles.</p>`);
        });
    </script>
</body>
</html>

